
- name: debug
  tags: debug
  hosts: all
  tasks:
    - name: install tools
      become: yes
      apt:
        name: "{{ item }}"
        state: present
      with_items:
        - nmap

- name: Install the Software
  tags: software
  hosts: hadoopnodes
  vars:
    yelp_version: "2016"

  tasks:
    - name: install dependencies
      become: yes
      apt:
        name: "{{ item }}"
        state: present
      with_items:
        - unzip


- name: Deploy the dataset
  tags: data
  hosts: frontendnodes
  vars:
    download_dir: "/tmp"
    db_dir: "/tmp/yelp"
    db_name: "yelp_dataset.zip"
    db4_path: "{{ db_dir }}/{{ databases.4.url | splitext | first }}"
    databases:
      4:
        url: "https://iu.box.com/shared/static/pj3lj9ily2g6rg5a19c14hut69b8fud2.zip"

  tasks:

    - name: install dependencies
      become: yes
      apt:
        name: unzip
        state: present

    - name: prepare the data directory
      file:
        path: "{{ item }}"
        state: directory
      with_items:
        - "{{ download_dir }}"
        - "{{ db_dir }}"

    - name: download
      get_url:
        url: "{{ databases.4.url }}"
        dest: "{{ download_dir }}"
        timeout: 600

    - name: extract
      become: yes
      unarchive:
        src: "{{ download_dir }}/{{ db_name }}"
        dest: "{{ db_dir }}"
        owner: hadoop
        group: hadoop
        creates: "{{ db4_path }}"
        copy: false

    - name: fix permissions
      become: yes
      file:
        path: "{{ db_dir }}"
        owner: hadoop
        group: hadoop
        recurse: yes

    - name: import databases into hdfs
      become: yes
      become_user: hadoop
      shell: "sh -lc 'hadoop fs -put {{ db_dir }} / && touch {{ db_dir }}/.imported-to-hdfs'"
      args:
        creates: "{{ db_dir }}/.imported-to-hdfs"


- name: Run the  analysis code
  tags: analysis
  hosts: frontendnodes
  tasks:
    - name: copy the analysis scripts
      become: yes
      copy:
        src: "{{ item }}"
        dest: "/home/hadoop/{{ item | basename }}"
        owner: hadoop
      with_items:
        - ./demo.pig
        - ./main.sh

